<script>
/* =====================================================
   MARKET TIME CHECK
===================================================== */
function isMarketOpen() {
  const now = new Date();
  const day = now.getDay();
  const hours = now.getHours();
  const minutes = now.getMinutes();

  if (day === 0 || day === 6) return false;

  const time = hours * 60 + minutes;
  return time >= 555 && time <= 930;
}

const marketOpen = isMarketOpen();

/* =====================================================
   FETCH FREE DELAYED NIFTY DATA (STOOQ)
===================================================== */
async function loadNiftyData() {
  const url = "https://stooq.com/q/d/l/?s=^nsei&i=d"; // CSV

  const response = await fetch(url);
  const text = await response.text();

  const rows = text.trim().split("\n");
  const lastRow = rows[rows.length - 1].split(",");

  const date = lastRow[0];
  const open = parseFloat(lastRow[1]);
  const high = parseFloat(lastRow[2]);
  const low = parseFloat(lastRow[3]);
  const close = parseFloat(lastRow[4]);

  renderStrategy({ date, open, high, low, close });
}

/* =====================================================
   STRATEGY LOGIC (CALL / PUT)
===================================================== */
function renderStrategy(data) {
  const { date, high, low, close } = data;

  let bias = "";
  let callPlan = "";
  let putPlan = "";

  if (marketOpen) {
    bias = "LIVE MARKET (Delayed Data View)";
  } else {
    bias = "MARKET CLOSED ‚Äî NEXT DAY PLAN";
  }

  callPlan = `
üìà <b>CALL (CE)</b><br>
Entry: Above <b>${high}</b><br>
Stop Loss: Below ${low}<br>
Target: ${(high + (high - low)).toFixed(2)} (1:2 RR)<br>
Logic: Break & hold above previous high
`;

  putPlan = `
üìâ <b>PUT (PE)</b><br>
Entry: Below <b>${low}</b><br>
Stop Loss: Above ${high}<br>
Target: ${(low - (high - low)).toFixed(2)} (1:2 RR)<br>
Logic: Break & hold below previous low
`;

  document.getElementById("status").innerHTML =
    marketOpen ? "üü¢ Market is OPEN" : "üî¥ Market is CLOSED";

  document.getElementById("analysis").innerHTML = `
<b>Date Used:</b> ${date}<br>
<b>NIFTY Close:</b> ${close}<br><br>

<b>Market Bias:</b> ${bias}<br><br>

<div style="margin-bottom:16px;">${callPlan}</div>
<div>${putPlan}</div>

<hr style="opacity:0.3">
<small>‚ö†Ô∏è Data is delayed. For learning & planning only.</small>
`;
}

/* =====================================================
   START
===================================================== */
loadNiftyData();
</script>
