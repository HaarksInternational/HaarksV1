<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>HAARKS â€“ Live Face Blur</title>

<style>
  body {
    margin: 0;
    overflow: hidden;
    background: black;
  }

  video, canvas {
    position: absolute;
    top: 0;
    left: 0;
  }

  #brand {
    position: fixed;
    top: 8px;
    left: 12px;
    font-family: Arial, sans-serif;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 1px;
    color: rgba(255,255,255,0.75);
    z-index: 10;
  }

  #hint {
    position: fixed;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%);
    font-family: Arial, sans-serif;
    font-size: 12px;
    color: rgba(255,255,255,0.65);
    z-index: 10;
  }
</style>
</head>

<body>

<div id="brand">HAARKS</div>
<div id="hint">Tap face to unblur / blur</div>

<video id="video" autoplay muted playsinline></video>
<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* ================= CORE ================= */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let faceLandmarks = null;
let blurEnabled = true;   // ðŸ”´ BLUR ON BY DEFAULT
const BLUR_PX = 32;
const PIXEL = 8;

/* ================= CAMERA ================= */
navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => {
    video.srcObject = stream;
    video.onloadedmetadata = () => video.play();
  });

/* ================= FACE MESH ================= */
const faceMesh = new FaceMesh({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
});

faceMesh.setOptions({
  maxNumFaces: 1,
  refineLandmarks: false,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
});

faceMesh.onResults(res => {
  if (res.multiFaceLandmarks && res.multiFaceLandmarks.length > 0) {
    faceLandmarks = res.multiFaceLandmarks[0];
  }
});

/* ================= TAP TO TOGGLE BLUR ================= */
canvas.addEventListener("click", () => {
  blurEnabled = !blurEnabled;
});

/* ================= RENDER LOOP ================= */
function render() {
  requestAnimationFrame(render);

  if (!video.videoWidth) return;

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  // draw camera
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  if (!faceLandmarks || !blurEnabled) return;

  // compute face bounds
  const xs = faceLandmarks.map(p => p.x * canvas.width);
  const ys = faceLandmarks.map(p => p.y * canvas.height);

  let minX = Math.min(...xs);
  let maxX = Math.max(...xs);
  let minY = Math.min(...ys);
  let maxY = Math.max(...ys);

  const w = maxX - minX;
  const h = maxY - minY;

  // expand slightly
  minX -= w * 0.15;
  minY -= h * 0.15;
  maxX += w * 0.15;
  maxY += h * 0.15;

  minX = Math.max(0, minX);
  minY = Math.max(0, minY);
  maxX = Math.min(canvas.width, maxX);
  maxY = Math.min(canvas.height, maxY);

  const bw = maxX - minX;
  const bh = maxY - minY;

  if (bw <= 0 || bh <= 0) return;

  // extract face
  const face = ctx.getImageData(minX, minY, bw, bh);

  // pixelation
  const sw = Math.max(1, Math.floor(bw / PIXEL));
  const sh = Math.max(1, Math.floor(bh / PIXEL));

  const small = document.createElement("canvas");
  small.width = sw;
  small.height = sh;
  const sctx = small.getContext("2d");
  sctx.imageSmoothingEnabled = false;
  sctx.putImageData(face, 0, 0);
  sctx.drawImage(small, 0, 0, sw, sh);

  const large = document.createElement("canvas");
  large.width = bw;
  large.height = bh;
  const lctx = large.getContext("2d");
  lctx.imageSmoothingEnabled = false;
  lctx.drawImage(small, 0, 0, bw, bh);

  lctx.filter = `blur(${BLUR_PX}px)`;
  lctx.drawImage(large, 0, 0);

  // oval mask
  ctx.save();
  ctx.beginPath();
  ctx.ellipse(
    minX + bw / 2,
    minY + bh / 2,
    bw / 2,
    bh / 2,
    0,
    0,
    Math.PI * 2
  );
  ctx.clip();
  ctx.drawImage(large, minX, minY);
  ctx.restore();
}

/* ================= MODEL LOOP (MOBILE SAFE) ================= */
const camera = new Camera(video, {
  onFrame: async () => {
    await faceMesh.send({ image: video });
  },
  width: 640,
  height: 480
});

camera.start();
render();
</script>

</body>
</html>
